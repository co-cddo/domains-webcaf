{% extends "base.html" %}
{% load review_tags %}
{% load form_extras %}
{% load permission_extras %}
{% block title %}Report history - {{ user.first_name }} {{ block.super }}{% endblock %}
{% block content %}
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-three-quarters">
            {% include 'partials/error_message.html' %}
            <span class="govuk-caption-l">{{ object.assessment.system.name }} ({{ object.assessment.reference }})</span>
            <h1 class="govuk-heading-l">Report history</h1>
            <p class="govuk-body">
                This page lists all versions of the IAR report for this system.
                You can view and download the current report or re-open the review to update it.
            </p>

            <p class="govuk-body">When you re-open the latest review it will create a new version of the report based on
                your changes.
                <br><br>Earlier versions of the report are saved for audit purposes.
            </p>

            <table class="govuk-table">
                <caption class="govuk-table__caption govuk-table__caption--m">List of created reports</caption>
                <thead class="govuk-table__head">
                <tr class="govuk-table__row">
                    <th scope="col" class="govuk-table__header">Version</th>
                    <th scope="col" class="govuk-table__header">Generated on</th>
                    <th scope="col" class="govuk-table__header">Generated by</th>
                    <th scope="col" class="govuk-table__header">Status</th>
                    <th scope="col" class="govuk-table__header">Actions</th>
                </tr>
                </thead>
                <tbody class="govuk-table__body">
                {% for revision in object.all_versions %}
                    <tr class="govuk-table__row">
                        <td class="govuk-table__cell">Version {{ forloop.revcounter }}</td>
                        <td class="govuk-table__cell">
                            {% if revision.instance.completion_info %}
                                {{ revision.instance.completion_info.review_completed_at|date:"d F Y" }}
                                at {{ revision.instance.completion_info.review_completed_at|date:"H:i" }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="govuk-table__cell">{{ revision.instance.completion_info.review_completed_by }}</td>
                        <td class="govuk-table__cell">
                            {% if forloop.counter == 1 %}
                                <span class="govuk-tag govuk-tag--blue">Current - with organisation</span>
                            {% else %}
                                <span class="govuk-tag govuk-tag--grey">Superseded</span>
                            {% endif %}
                        </td>
                        <td class="govuk-table__cell">
                            <a class="govuk-link" href="{% url 'show-report' pk=revision.instance.id version=forloop.revcounter %}">View report</a>
                            <a class="govuk-link" target="_blank" href="{% url 'download-report' pk=revision.instance.id version=forloop.revcounter %}">Download (PDF)</a>
                        </td>
                    </tr>
                {% endfor %}
            </table>

            <h2 class="govuk-heading-m"> Create a new report version</h2>
            <p class="govuk-body">
                To create a new version of the report, you must <strong>re-open the current review</strong>
                and make the changes you need.
                You will be able to change outcome statuses, recommendations and comments.
            </p>

            <form method="post" id="reopen-review-form">
                {% csrf_token %}
                <button type="submit" class="govuk-button govuk-button--warning"
                        {% if not object.can_edit %} disabled="disabled" aria-disabled="true"  {% endif %}
                >Open current review to create a new
                    report
                </button>
            </form>

            <p class="govuk-body govuk-!-margin-top-6">
                <a href="{% url 'my-account' %}" class="govuk-link">Return to My account</a>
            </p>

        </div>
    </div>
{% endblock %}
