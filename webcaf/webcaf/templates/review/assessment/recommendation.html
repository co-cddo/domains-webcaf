{% extends "review-base.html" %}
{% load review_tags %}
{% load form_extras %}
{% load permission_extras %}
{% block title %} Review Objective {{ objective_code }} - {{ user.first_name }} {{ block.super }}{% endblock %}
{% block content %}
    <div class="govuk-grid-row">
        {% get_review_completed_percentage object as percentage %}
        {% include "partials/review_progress_indicator.html" with percentage=percentage %}
        <div class="govuk-grid-column-three-quarters">
            {% if form.non_form_errors or form.errors|filter_empty %}
                <div class="govuk-error-summary" aria-labelledby="error-summary-title" role="alert" tabindex="-1">
                    <h2 class="govuk-error-summary__title" id="error-summary-title">
                        There is a problem
                    </h2>
                    <div class="govuk-error-summary__body">
                        <ul class="govuk-list govuk-error-summary__list">
                            {% for form_ in form %}
                                {% for field in form_.visible_fields %}
                                    {% for error in field.errors %}
                                        <li><a href="#{{ field.id_for_label }}">{{ field.label }} :{{ error }}</a></li>
                                    {% endfor %}
                                {% endfor %}
                                {% for error in form_.non_field_errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            {% endif %}
            <span class="govuk-caption-l">{{ title }}</span>
            <h1 class="govuk-heading-l">Add your recommendations</h1>
            <p class="govuk-body">You must give each recommendation a short, clear title. Where appropriate, it should
                reference language from the relevant <abbr title="Indicators of Good Practice">IGP</abbr>(s).</p>
            <p class="govuk-body">Add details and rationale for your recommendation, referencing the risk it is
                addressing.</p>
            <p class="govuk-body">Please refer to the full <a
                    href="https://www.security.gov.uk/policy-and-guidance/govassure/stage-4-independent-assurance-review/"
                    target="_blank">stage 4 guidance (opens in new tab)</a> to support you and see an example
                recommendation.</p>
            <form method="post" id="review-form">
                {% csrf_token %}
                {{ form.management_form }}
                {#  Preview form tracks if we need to send the request for preview #}
                {{ preview_form.preview_status }}
                <div id="form-container">
                    {% for form_ in form %}
                        <div class="govuk-form-group" id="recommendation-container_{{ forloop.counter0 }}">
                            <h2 class="govuk-heading-m">Recommendation {{ forloop.counter0|add:1 }}</h2>
                            <div class="govuk-form-group {% if form_.title.errors %}govuk-form-group--error{% endif %}">
                                <label class="govuk-label"
                                       for="id_form-{{ forloop.counter0 }}-title">{{ form_.title.label }}</label>
                                <input class="govuk-input govuk-input--width-30" type="text"
                                       name="{{ form_.title.html_name }}"
                                       id="id_form-{{ forloop.counter0 }}-title"
                                       value="{{ form_.title.value|default:"" }}"
                                >
                            </div>
                            <div data-module="govuk-character-count"
                                 data-maxwords="{{ form_.text.field.widget.attrs.max_words }}"
                                 class="govuk-character-count govuk-form-group {% if form_.text.errors %}govuk-form-group--error{% endif %}">
                                <label class="govuk-label"
                                       for="id_form-{{ forloop.counter0 }}-text">{{ form_.text.label }}
                                </label>
                                <textarea class="govuk-textarea govuk-js-character-count"
                                          name="{{ form_.text.html_name }}" cols="40" rows="5"
                                          id="id_form-{{ forloop.counter0 }}-text">{{ form_.text.value|default:"" }}</textarea>
                                <div id="id_form-{{ forloop.counter0 }}-text-info"
                                     class="govuk-hint govuk-character-count__message">You can
                                    enter up to
                                    {{ form_.text.field.widget.attrs.max_words }} words
                                </div>
                            </div>
                            <button type="button" class="govuk-button govuk-button--secondary remove-button"
                                    data-module="govuk-button"
                                    {% if not object.can_edit %} disabled="disabled" aria-disabled="true"  {% endif %}
                                    data-idx="{{ forloop.counter0 }}"
                                    data-name="{{ form_.DELETE.html_name }}">
                                Remove
                            </button>
                            <hr class="govuk-section-break govuk-section-break--visible govuk-section-break--l">
                        </div>
                    {% endfor %}
                </div>
                <button type="button" class="govuk-button govuk-button--secondary" data-module="govuk-button"
                        {% if not object.can_edit %} disabled="disabled" aria-disabled="true"  {% endif %}
                        id="add-recommendation-button"
                >
                    Add another recommendation
                </button>
                <br/>
                <button type="submit" class="govuk-button" data-module="govuk-button"
                        {% if not object.can_edit %} disabled="disabled" aria-disabled="true"  {% endif %}
                >
                    Save and continue
                </button>
            </form>
        </div>
    </div>
    <div class="govuk-form-group govuk-visually-hidden" id="recommendation-container_--counter--">
        <h2 class="govuk-heading-m">Recommendation --counter-plus-one--</h2>
        <div class="govuk-form-group">
            <label class="govuk-label"
                   for="id_form---counter---title">Title</label>
            <input class="govuk-input govuk-input--width-30" type="text"
                   name="form---counter---title"
                   id="id_form---counter---title"
            >
        </div>
        <div class="govuk-character-count govuk-form-group"
             id="id_form---counter---text-container"
                {#Had to hardcode the value here as we dont have a form instance access#}
             data-maxwords="750">
            <label class="govuk-label" for="id_form---counter---text">Details and rationale
            </label>
            <textarea class="govuk-textarea govuk-js-character-count"
                      name="form---counter---text" cols="40" rows="5"
                      id="id_form---counter---text"></textarea>
            <div id="id_form---counter---text-info"
                 class="govuk-hint govuk-character-count__message">You can
                enter up to 750 words
            </div>
        </div>
        <button type="button" class="govuk-button govuk-button--secondary remove-button"
                data-module="govuk-button"
                data-idx="--counter--"
                id="id_form---counter---remove-button"
                data-name="form---counter---DELETE">
            Remove
        </button>
        <hr class="govuk-section-break govuk-section-break--visible govuk-section-break--l">
    </div>
    <script type="text/javascript" nonce="{{ request.csp_nonce }}">
        function deleteRecommendationHandler() {
            return e => {
                e.preventDefault();
                var element_name = e.target.dataset.name;
                var _form = document.getElementById("review-form");
                var _delete = document.createElement("input");
                _delete.setAttribute("type", "hidden");
                _delete.setAttribute("name", element_name);
                _delete.setAttribute("value", "on");
                _form.appendChild(_delete);
                e.target
                    .closest("form")
                    .querySelector(`div[id="recommendation-container_${e.target.dataset.idx}"]`)
                    .hidden = true;
            };
        }

        document.querySelectorAll(".remove-button").forEach(button => button.addEventListener("click", deleteRecommendationHandler()))
        const button = document.getElementById("add-recommendation-button");
        button.addEventListener("click", e => {
            e.preventDefault();

            const total_forms = document.getElementById("id_form-TOTAL_FORMS");
            const template = document.getElementById("recommendation-container_--counter--");
            const clone = template.cloneNode(true);
            clone.classList.remove("govuk-visually-hidden");

            // Update IDs and text individually instead of innerHTML replacement
            clone.id = `recommendation-container_${total_forms.value}`;
            clone.querySelector("h2").textContent = `Recommendation ${parseInt(total_forms.value) + 1}`;
            clone.querySelector("label[for^='id_form---counter---title']").setAttribute("for", `id_form-${total_forms.value}-title`);
            clone.querySelector("input").setAttribute("id", `id_form-${total_forms.value}-title`);
            clone.querySelector("input").setAttribute("name", `form-${total_forms.value}-title`);

            const textContainer = clone.querySelector(".govuk-character-count");
            textContainer.setAttribute("id", `id_form-${total_forms.value}-text-container`);
            textContainer.setAttribute("data-module", "govuk-character-count");
            textContainer.querySelector("label").setAttribute("for", `id_form-${total_forms.value}-text`);
            const textarea = textContainer.querySelector("textarea");
            textarea.setAttribute("id", `id_form-${total_forms.value}-text`);
            textarea.setAttribute("name", `form-${total_forms.value}-text`);

            const info = textContainer.querySelector("div#id_form---counter---text-info");
            info.setAttribute("id", `id_form-${total_forms.value}-text-info`);
            info.setAttribute("name", `form-${total_forms.value}-text-info`);

            const form_container = document.getElementById("form-container");
            form_container.appendChild(clone);

            const removeButton = document.getElementById(`id_form---counter---remove-button`);
            removeButton.setAttribute("id", `id_form-${total_forms.value}-remove-button`);
            removeButton.setAttribute("data-idx", `${total_forms.value}`);
            removeButton.addEventListener("click", deleteRecommendationHandler());

            // Initialise only the new CharacterCount
            init_char_count(textContainer);

            total_forms.value = parseInt(total_forms.value) + 1;
        });    </script>
{% endblock %}
