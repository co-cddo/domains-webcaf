{% load form_extras %}
{% if form.errors %}
    <div class="govuk-error-summary" aria-labelledby="error-summary-title" role="alert" tabindex="-1"
         data-module="govuk-error-summary">
        <h2 class="govuk-error-summary__title" id="error-summary-title">
            There is a problem
        </h2>
        <div class="govuk-error-summary__body">
            <ul class="govuk-list govuk-error-summary__list">
                {% for field in form %}
                    {% for error in field.errors %}
                        <li><a href="#id_{{ field.name|safe_id }}">{{ error }}</a></li>
                    {% endfor %}
                {% endfor %}
                {% for error in form.non_field_errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <script nonce="{{ request.csp_nonce }}">
        document.querySelectorAll("ul.govuk-list.govuk-error-summary__list a")
            .forEach(function (anchor) {
                anchor.addEventListener("click", function (event) {
                    event.preventDefault();

                    const targetSelector = anchor.getAttribute("href");
                    const targetElement = document.querySelector(targetSelector);

                    if (targetElement) {
                        // Step 1: find parent tab panel
                        const tabPanel = targetElement.closest(".govuk-tabs__panel");
                        if (tabPanel) {
                            const panelId = tabPanel.id;

                            // Step 2: find tab button that activates this panel
                            const tabButton = document.querySelector(
                                `.govuk-tabs__list-item a[href="#${panelId}"]`
                            );

                            if (tabButton) {
                                // Activate the tab using the GOV.UK Tabs API (preferred)
                                const tabs = document.querySelector(".govuk-tabs");
                                if (tabs && tabs.GOVUKTabs) {
                                    tabs.GOVUKTabs.showPanel(tabPanel.id);
                                } else {
                                    // Fallback: simulate click on the tab button
                                    tabButton.click();
                                }
                            }
                        }

                        // Step 3: scroll smoothly to the target
                        setTimeout(() => {
                            targetElement.scrollIntoView({behavior: "smooth", block: "center"});
                            targetElement.focus({preventScroll: true}); // accessibility
                        }, 200); // slight delay so tab panel has time to open
                    }
                });
            })
    </script>
{% endif %}
